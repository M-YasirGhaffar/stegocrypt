{% extends "base.html" %}
{% block title %}Upload & Decrypt{% endblock title %}

{% block nav_links %}
  {% if user.is_authenticated %}
    <a href="{% url 'index' %}" class="text-blue-600 hover:underline">Dashboard</a>
    <a href="{% url 'decrypt-upload' %}" class="text-blue-600 hover:underline">Upload & Decrypt</a>
    <a href="{% url 'logout' %}" class="text-blue-600 hover:underline">Logout</a>
  {% else %}
    <a href="{% url 'index' %}" class="text-blue-600 hover:underline">Home</a>
    <a href="{% url 'login' %}" class="text-blue-600 hover:underline">Login</a>
    <a href="{% url 'register' %}" class="text-blue-600 hover:underline">Register</a>
  {% endif %}
{% endblock nav_links %}

{% block content %}
<div class="max-w-md mx-auto bg-white rounded shadow p-6 my-4">
  <h3 class="text-xl font-semibold mb-4">Decrypt External Image</h3>
  <p class="text-sm text-gray-600 mb-4">
    Provide the pass-key for externally uploaded images. 
    Account password won't help for external images not in the DB.
  </p>

  <form method="POST" 
        enctype="multipart/form-data" 
        class="space-y-4"
        x-data="{ preview: null }">
    {% csrf_token %}
    
    <!-- File Upload with Preview -->
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700">
        Select encrypted image
      </label>
      <input type="file" 
             name="{{ form.stego_image_file.name }}"
             accept="image/*"
             class="block w-full text-sm border rounded px-3 py-2 focus:outline-none focus:border-blue-500"
             @change="preview = URL.createObjectURL($event.target.files[0])">
      
      <!-- Preview Container -->
      <template x-if="preview">
        <div class="mt-2 aspect-w-4 aspect-h-3 bg-gray-50 rounded-lg overflow-hidden">
          <img :src="preview" 
               class="object-cover w-full h-full"
               alt="Upload Preview">
        </div>
      </template>
    </div>

    <!-- Password/Key Input -->
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700" for="{{ form.pass_or_pw.id_for_label }}">
        Pass-Key
      </label>
      <input type="password"
             name="{{ form.pass_or_pw.name }}"
             id="{{ form.pass_or_pw.id_for_label }}"
             class="block w-full text-sm border rounded px-3 py-2 focus:outline-none focus:border-blue-500"
             placeholder="Enter pass-key for decryption">
    </div>

    <!-- Submit Button -->
    <button type="submit" 
            class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition duration-200">
      Decrypt Image
    </button>
  </form>

  <!-- Error Messages -->
  {% if form.errors %}
    <div class="mt-4 bg-red-50 text-red-600 p-3 rounded">
      {% for field, errors in form.errors.items %}
        {% for error in errors %}
          <p class="text-sm">{{ error }}</p>
        {% endfor %}
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}